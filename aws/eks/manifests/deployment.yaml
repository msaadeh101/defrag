apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app-deployment
  labels:
    app: web-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web-app-pod # Critical: Links deployment to pods it manages
  template:
    metadata:
      labels:
        app: web-app-pod # Labels applied to pods created by this deployment
    spec:
      # CRITICAL ADDITION: Defines the ServiceAccount used by Pods for IRSA/CSI driver access.
      serviceAccountName: api-data-access 
      
      containers:
      - name: web-app-container
        image: accountID.dkr.ecr.us-east-1.amazonaws.com/web-app:v1.2
        ports:
        - containerPort: 8080 # Port the app inside the container is listening on
        
        # CRITICAL ADDITION: Mounts the volume for secrets retrieval.
        volumeMounts:
        - name: secrets-volume # References the volume defined below.
          mountPath: "/mnt/secrets" # The directory inside the container where files will appear.
          readOnly: true
          
        # Optional: Access the secrets via environment variables by reading the mounted files.
        # This requires the CSI driver to be configured to auto-create a Kubernetes Secret 
        # (or the application reads the files directly from /mnt/secrets).
        env: 
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: app-db-secret # The name of the (auto-generated) Kubernetes Secret.
              key: DB_HOST # The key (filename) defined in SecretProviderClass.
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-db-secret # The name of the (auto-generated) Kubernetes Secret.
              key: DB_PASSWORD # The key (filename) defined in SecretProviderClass.

        resources:
          limits:
            cpu: "500m"     # Upper limit: Pod cannot use more than 0.5 CPU cores.
            memory: "512Mi" # Upper limit: Pod cannot use more than 512 MiB of memory.
          requests:
            cpu: "250m"     # Min request: Scheduler must reserve 0.25 CPU cores for this Pod.
            memory: "256Mi" # Min request: Scheduler must reserve 256 MiB of memory for this Pod.
            
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 15 # Wait 15s before starting liveness check
          periodSeconds: 20       # Check every 20s. If this fails, the container is restarted.
          
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          periodSeconds: 5        # Check every 5s, if fails, pod is taken out out of service
          
      # CRITICAL ADDITION: Defines the volume source for the Secrets Store CSI driver.
      volumes:
      - name: secrets-volume
        csi:
          driver: secrets-store.csi.k8s.io # Specifies the CSI driver for secret injection.
          readOnly: true
          volumeAttributes:
            # CRITICAL: References the separate SecretProviderClass manifest.
            # This is the link that tells the CSI driver *which* AWS secret to fetch.
            secretProviderClass: rds-secret-provider